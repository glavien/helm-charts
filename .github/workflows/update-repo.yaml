name: Update Helm Repository

on:
  repository_dispatch:
    types: [new-chart-release]
  workflow_dispatch:
    inputs:
      repository:
        description: 'Source repository (owner/repo)'
        required: true
      tag:
        description: 'Release tag'
        required: true

jobs:
  update:
    name: Update Chart Index
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Set variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "repository=${{ github.event.client_payload.repository }}" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "repository=${{ github.event.inputs.repository }}" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Download release artifact
        run: |
          REPO="${{ steps.vars.outputs.repository }}"
          TAG="${{ steps.vars.outputs.tag }}"
          VERSION="${{ steps.vars.outputs.version }}"
          
          echo "Downloading chart from repository: $REPO, tag: $TAG, version: $VERSION"
          
          # Get the release info
          RELEASE_INFO=$(curl -s "https://api.github.com/repos/$REPO/releases/tags/$TAG")
          
          # Check if release exists
          if echo "$RELEASE_INFO" | jq -e '.message == "Not Found"' >/dev/null; then
            echo "‚ùå Release $TAG not found in repository $REPO"
            exit 1
          fi
          
          # Find the exact chart file for this version
          EXPECTED_CHART_NAME="hostendpoint-operator-${VERSION}.tgz"
          
          echo "Looking for chart file: $EXPECTED_CHART_NAME"
          echo "Available assets:"
          echo "$RELEASE_INFO" | jq -r '.assets[].name'
          
          CHART_URL=$(echo "$RELEASE_INFO" | jq -r --arg name "$EXPECTED_CHART_NAME" '.assets[] | select(.name == $name) | .browser_download_url')
          
          if [ "$CHART_URL" = "null" ] || [ -z "$CHART_URL" ]; then
            echo "‚ùå Expected chart file $EXPECTED_CHART_NAME not found in release $TAG"
            
            # Try to find any chart file as fallback
            echo "Trying fallback: any .tgz file containing version $VERSION"
            CHART_URL=$(echo "$RELEASE_INFO" | jq -r --arg version "$VERSION" '.assets[] | select(.name | endswith(".tgz")) | select(.name | contains($version)) | .browser_download_url' | head -1)
            CHART_NAME=$(echo "$RELEASE_INFO" | jq -r --arg version "$VERSION" '.assets[] | select(.name | endswith(".tgz")) | select(.name | contains($version)) | .name' | head -1)
            
            if [ "$CHART_URL" = "null" ] || [ -z "$CHART_URL" ]; then
              echo "‚ùå No suitable chart file found"
              exit 1
            fi
            
            echo "‚ö†Ô∏è  Using fallback chart: $CHART_NAME"
          else
            CHART_NAME="$EXPECTED_CHART_NAME"
          fi
          
          echo "‚úÖ Found chart: $CHART_NAME"
          echo "üì• Download URL: $CHART_URL"
          
          # Download the chart package
          if ! curl -L -o "$CHART_NAME" "$CHART_URL"; then
            echo "‚ùå Failed to download chart file"
            exit 1
          fi
          
          # Verify download
          if [ ! -f "$CHART_NAME" ]; then
            echo "‚ùå Chart file not found after download"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s "$CHART_NAME")
          if [ "$FILE_SIZE" -lt 1000 ]; then
            echo "‚ùå Downloaded file is too small ($FILE_SIZE bytes), probably an error page"
            cat "$CHART_NAME"
            exit 1
          fi
          
          echo "‚úÖ Successfully downloaded chart:"
          ls -la *.tgz

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Update Helm repository index
        run: |
          # Create charts directory if it doesn't exist
          mkdir -p charts
          
          # Move all downloaded charts to charts directory
          mv *.tgz charts/
          
          # Generate/update the index.yaml
          helm repo index charts --url https://glavien.github.io/helm-charts/charts
          
          # Move index.yaml to root for GitHub Pages
          cp charts/index.yaml ./index.yaml
          
          echo "Repository updated:"
          ls -la
          echo "Charts directory:"
          ls -la charts/
          echo "Index.yaml content:"
          cat index.yaml

      - name: Commit and push changes
        run: |
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "chore: update chart repository with ${{ steps.vars.outputs.repository }}@${{ steps.vars.outputs.tag }}"
            git push origin gh-pages
            echo "Repository index updated successfully"
          else
            echo "No changes to commit"
          fi